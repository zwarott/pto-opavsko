# Překážky těžkého opevnění na Opavsku

Projekt se zaměřuje na vektorizaci průběhu překážek těžkého opevnění
v úseku ŽSV (Ženijní skupinové velitelství) IV. Opava, a to konkrétně 
kolem srubů stavebního úseku Opava (OP-S).

## Členění řešeného území
| Úsek          | Podúsek      | Srub                     |
| --------------|------------- | -------------------------|
| ŽSV IV. Opava | Malé Hoštice | OP-S 06 Na Zbytkovém     |
| ŽSV IV. Opava | Malé Hoštice | OP-S 09 Na Lukách        |
| ŽSV IV. Opava | Malé Hoštice | OP-S 10 Na Křižovatce    |
| ŽSV IV. Opava | Malé Hoštice | OP-S 11 U cihelny        |
| ŽSV IV. Opava | Malé Hoštice | OP-S 12 Na rytířském     |
| ŽSV IV. Opava | Malé Hoštice | OP-S 13 U pískovny       |
| ŽSV IV. Opava | Malé Hoštice | OP-S 14 U obrázku        |
| ŽSV IV. Opava | Malé Hoštice | OP-S 15 U kruhovky       |
| ŽSV IV. Opava | Jaktař       | OP-S 16 Na středním poli |
| ŽSV IV. Opava | Jaktař       | OP-S 17 Nad silnicí      |
| ŽSV IV. Opava | Jaktař       | OP-S 18 U sádrovce       |
| ŽSV IV. Opava | Jaktař       | OP-S 19 U finanční budky |
| ŽSV IV. Opava | Jaktař       | OP-S 20 Na střelnici     |
| ŽSV IV. Opava | Jaktař       | OP-S 21 Na cvičišti      | 
| ŽSV IV. Opava | Jaktař       | OP-S 22 Nad úvozem       | 
| ŽSV IV. Opava | Jaktař       | OP-S 23 Nad potokem      | 
| ŽSV IV. Opava | Jaktař       | OP-S 24 Na Gelově poli   | 
| ŽSV IV. Opava | Milostovice  | OP-S 25 U trigonometru   | 
| ŽSV IV. Opava | Milostovice  | OP-S 26 U Milostovic     | 
| ŽSV IV. Opava | Milostovice  | OP-S 27 Paletovo pole    | 
| ŽSV IV. Opava | Milostovice  | OP-S 28 Mezicestí        | 
| ŽSV IV. Opava | Milostovice  | OP-S 29 Rozcestí         | 
| ŽSV IV. Opava | Šibenice     | OP-S 30 Šibenice         | 
| ŽSV IV. Opava | Šibenice     | OP-S 31 U cesty          | 
| ŽSV IV. Opava | Šibenice     | OP-S 32 Kopaniny         | 
| ŽSV IV. Opava | Šibenice     | OP-S 36a Horní Dvoják    | 
| ŽSV IV. Opava | Šibenice     | OP-S 36b Dolní Dvoják    | 

## Podklady
### Archivní letecké meřické snímky
| OP-S | Rok pořízení | Kód snímku |
|------|--------------|------------|
| 06   | 1946         | OPAV54     |
| 09   | 1946         | OPAV74     |
| 10   | 1946         | OPAV74     |
| 11   | 1946         | OPAV73     |
| 12   | 1946         | OPAV73     |
| 13   | 1946         | OPAV73     |
| 14   | 1946         | OPAV73     |
| 15   | 1946         | OPAV73     |
| 16   | 1946         | OPAV83     |
| 17   | 1946         | OPAV83     |
| 18   | 1946         | OPAV83     |
| 19   | 1946         | OPAV93     |
| 20   | 1946         | OPAV93     |
| 21   | 1946         | OPAV93     |
| 22   | 1946         | OPAV93     |
| 23   | 1946         | HBEN02     |
| 24   | 1946         | HBEN02     |
| 25   | 1946         | HBEN02     |
| 26   | 1946         | HBEN02     |
| 27   | 1946         | HBEN02     |
| 28   | 1946         | HBEN12     |
| 29   | 1946         | HBEN12     |
| 30   | 1955         | HBEN12     |
| 31   | 1955         | HBEN12     |
| 32   | 1955         | HBEN21     |
| 36a  | 1955         | HBEN21     |
| 36b  | 1955         | HBEN21     |

### Stavební výkresy ŽSV IV. Opava
| OP-S | Pořízeno   | Měřítko   |
|------|------------|-----------|
| 06   | 19.08.1937 | 1 : 2 880 | 
| 09   | 19.08.1937 | 1 : 2 500 |
| 10   | 19.08.1937 | 1 : 2 500 |
| 11   | 19.08.1937 | 1 : 2 500 | 
| 12   | 19.08.1937 | 1 : 2 500 |
| 13   | 19.08.1937 | 1 : 2 880 |
| 14   | 19.08.1937 | 1 : 2 880 |
| 15   | 19.08.1937 | 1 : 2 880 |
| 16   | 19.08.1937 | 1 : 2 880 |
| 17   | 19.08.1937 | 1 : 2 880 |
| 18   | 19.08.1937 | 1 : 2 880 |
| 19   | 19.08.1937 | 1 : 2 880 |
| 20   | 19.08.1937 | 1 : 2 880 |
| 21   | 19.08.1937 | 1 : 2 880 |
| 22   | 19.08.1937 | 1 : 2 880 |
| 23   | -          | -         |
| 24   | 23.08.1937 | 1 : 2 500 |
| 25   | 23.08.1937 | 1 : 2 500 |
| 26   | -          | -         |
| 27   | 23.08.1937 | 1 : 2 500 |
| 28   | 23.08.1937 | 1 : 2 500 |
| 29   | 23.08.1937 | 1 : 2 500 |
| 30   | 23.08.1937 | 1 : 2 500 |
| 31   | neuvedeno  | neuvedeno |
| 31   | neuvedeno  | neuvedeno |

### Vyúčtovací plány ŽSV IV. Opava 
| OP-S | Pořízeno    | Měřítko   |
|------|-------------|-----------|
| 06   | 16.06.1938? | 1 : 2 880 | 
| 09   | 16.06.1938? | 1 : 2 500 | 
| 10   | 16.06.1938? | 1 : 2 500 | 
| 11   | 16.06.1938? | 1 : 2 500 | 
| 12   | 16.06.1938? | 1 : 2 500 | 
| 13   | 16.06.1938? | 1 : 2 880 | 
| 14   | 16.06.1938? | 1 : 2 880 | 
| 15   | 16.06.1938? | 1 : 2 880 | 
| 16   | 16.06.1938? | 1 : 2 880 | 
| 17   | 16.06.1938? | 1 : 2 880 | 
| 18   | 16.06.1938? | 1 : 2 880 | 
| 19   | 16.06.1938? | 1 : 2 880 | 
| 20   | 16.06.1938? | 1 : 2 880 | 
| 21   | 16.06.1938? | 1 : 2 880 | 
| 22   | 16.06.1938? | 1 : 2 880 | 
| 23   | 16.06.1938? | 1 : 2 880 | 
| 24   | 16.06.1938? | 1 : 2 500 | 
| 25   | 16.06.1938? | 1 : 2 500 | 
| 26   | 16.06.1938? | 1 : 2 500 | 
| 27   | 16.06.1938? | 1 : 2 500 | 
| 28   | 16.06.1938? | 1 : 2 500 | 
| 29   | 16.06.1938? | 1 : 2 880 | 
| 30   | 16.06.1938? | 1 : 2 880 | 
| 31   | 16.06.1938? | 1 : 2 880 | 
| 32   | 16.06.1938? | 1 : 2 880 | 
| 36a  | 16.06.1938? | 1 : 2 880 | 
| 36b  | 16.06.1938? | 1 : 2 880 | 

### Československé mapové listy v měřítku 1:75000
| Kód  | Název            | Vydáno  |
|------|------------------|---------|
| 3959 | Krnov            | 06.1938 | 
| 3960 | Sudice           | 05.1938 |
| 4059 | Bruntál          | 05.1938 |
| 4060 | Moravská Ostrava | 09.1938 |

### Neměcké mapové listy - Befestigungskarte Tschechoslowakei v měřítku 1:75000 
| Kód  | Název      | Vydáno   | Přítisk     |
|------|------------|----------|-------------|
| 3959 | Troplowitz | 08.1938? | 15.07.1938  |
| 3960 | Ratibor    | 02.1938? | 15.07.1938  |
| 4059 | Bruntál    | 02.1938? | 15.07.1938  |
| 4060 | Hultschin  | 02.1938? | 15.07.1938  |


- DMR 5G
- Archivní fotodokumentace
- Měření a fotodokumentace z terénu
- Schémata a profily jednotlivých kategorií překážek
- Kniha Tvrze československého opevnění 1935-1938 II.


## Postup prací
### Georeferencování
### Analýza dobových fotografií
### Vektorizace


## Databáze
### Konfigurace databáze
:warning: Rozepsat + uvést rozšíření o extenzi PostGIS.

### Struktura databáze
```
pto_opavsko
├── audit
│   ├── centroidy_atlas_history
│   ├── csr_pred_zaborem_history
│   ├── geodeticke_zamereni_history
│   ├── mrizka_m2000_history
│   ├── palebne_zvony_history
│   ├── pomocne_linie_history
│   ├── pozice_srubu_main_history
│   ├── pozice_srubu_overview_history
│   ├── pozorovatel_pohled_history
│   ├── pozorovatel_pozice_history
│   ├── prekazky_buffer_50m_history
│   ├── prekazky_linie_history
│   ├── prubeh_prekazek_history
│   └── sruby_ruian_history
├── detail
│   ├── geodeticke_zamereni
│   ├── schema_body
│   ├── schema_koty
│   ├── schema_linie
│   └── schema_useky
├── lookups
│   ├── kat_vp_lookup
│   ├── katastr_lookup
│   ├── kategorie_lookup
│   ├── ops_lookup
│   ├── podusek_lookup
│   ├── srub_nazev_lookup
│   ├── srub_typ_lookup
│   ├── stav_lookup
│   └── usek_lookup
├── main
│   ├── centroidy_atlas
│   ├── delici_linie_gen
│   ├── hranice_cr
│   ├── mrizka_m2000
│   ├── palebne_zvony
│   ├── pomocne_linie
│   ├── pozice_srubu_main
│   ├── pozorovatel_pohled
│   ├── pozorovatel_pozice
│   ├── prekazky_agregovane
│   ├── prekazky_buffer_50m
│   ├── prekazky_gen
│   ├── prekazky_linie
│   ├── prekazky_test
│   └── sruby_ruian
├── overview_13kk
│   ├── csr_pred_zaborem
│   └── csr_pred_zaborem_label
├── overview_75k
│   ├── buffered_400m
│   ├── ipenky
│   ├── pozice_srubu_overview
│   └── prubeh_prekazek
└── public
    ├── geography_columns
    ├── geometry_columns
    ├── layer_styles
    ├── qgis_projects
    └── spatial_ref_sys
```

#### Schéma `audit` 
Schéma obsahuje tabulky, které zaznamenávají změny při editace (geometrie + další informativní údaje).
Účelem tabulek s příponou `_history` je trasování změn ve vrstvách obsahující zejména prostorovou informaci. 
V případě potřeby lze obnovit původní geometrii vrstvy uloženou v určitém řádku.

##### Příklad auditu vybraného prvku 
`audit.prekazky_linie_history` trasuje změny v hlavní tabulce `main.prekazky_linie`. Informace ohledně editace
jsou uloženy ve sloupci `valid_range`, ve kterém se zaznamenává proces vytvoření, aktualizace a odstranění prvku
vrstvy (tabulky). Jednotlivým změnám v tabulce je přiřazen unikátní identifikátor (`hid`). Ty jsou v tabulce
zaznamenávány chronologicky.

Na níže uvedené ukázce je demonstrován proces změny vybraného prvku v tabulce s (`fid = 47`). Tento prvek byl 
vytvořen `2023-01-03 21:24:41` a naposledy změněn v `2024-03-25 22:07:39`.

První časový záznam v hranaté závorce představuje čas, kdy byl prvek buď vytvořen (`hid = 160`) nebo aktualizován
`hid IN (379, 487, 705)`. Druhý časový záznam v hranaté závorce představuje čas, kdy byl prvek buď odstraněn nebo
aktualizován `hid IN (379, 487, 705)`. V případě aktualizace je nejdříve u vytvořeného prvku vyplněn druhý časový
záznam. Následně je vygenerován nový řádek, kde je vložen duplikát druhého časového záznamu předchozího řádku.
Aktualizace prvku se tedy chová jako kdyby byl prvek odstraněn a ihned znovu vytvořen.

<img src="./docs_images/prekazky_linie_history.png" alt="Audit vrstvy" style="width:800px;height:100px;"/>


##### :point_right: Příklad filtrování prvků dle časových záznamů
Pro účely auditu editace prvků v tabulce (momentálně jen `main.prekazky_linie`) jsou vytvořeny SQL s vstupními
proměnými. Tyto skripty jsou nastaveny tak, aby je bylo možné spustit v interaktivním porstředí `psql`.

Audit vybraného prvku lze spustit příkazem:
`psql \set _fid 47 \i ./database/audit/from_to_prekazky_linie.sql'`

Audit vybraných prvků v určitém časovém rozpětí lze spustit příkazem:
`psql \set _from 'YYYY-MM-DD' \set _to 'YYYY-MM-DD \i ./database/audit/from_to_prekazky_linie.sql'`

Audit vybraných prvků od určitého časového záznamu lze spustit příkazem: 
`psql \set _from 'YYYY-MM-DD' \i ./database/audit/over_prekazky_linie.sql'`

Audit vybraných prvků do určitého časového záznamu lze spustit příkazem: 
`psql \set _to 'YYYY-MM-DD' \i ./database/audit/under_prekazky_linie.sql'`

> :warning: Bude vytvořen Python script pro audit vybrané tabulky ve schématu `audit`.

#### Schéma `detail` 
Schéma obsahuje vrstvy v podrobném měřítku (zpravidla 1 : 1 000 a větším). Jedná se zejména o geodetické
zaměření a detailní provedení liniových překážek opevnění.


#### Schéma `lookups` 
Schéma obsahuje tabulky bez prostorové informace. Jedná se o tzv. tabulky s cizími klíčy, neboli tabulky s vybraným
atributem (sloupcem), pro který jsou přednastaveny povolené vstupní hodnoty. Po propojení s cílovou tabulkou (vrstvou)
je zabezpečeno, že do vybraného atributu nebude vložena hodnota nebo údaj, který není nadefinován v propojené tabulce
v rámci schématu `lookup`.

> :bulb: Využití cizích klíčů nabízí možnost propojit nastavení PostgreSQL omezení s QGIS Forms. Při editaci vrstvy v
> prostředí QGIS uživatel vybírá hodnotu/údaj z přednastaveného seznamu. Tím je zaručena eliminace chyb při ručním vyplňování 
> v atributové tabulce.

##### :point_right: Příklad propojení tabulek za použití cizích klíčů
Atribut `podusek` v tabulce `overview_75k.pozice_srubu_overview` může obsahovat pouze údaje, které jsou obsažené ve
sloupci `podusek` v tabulce `lookups.podusek_lookup`.
<img src="./docs_images/podusek_pop_up_menu.png.png" alt="QGIS pop-up menu" style="width:800px;height:100px;"/>


#### Schéma `main` 
Schéma obsahuje vrstvy (tabulky) zobrazitelné ve standardním měřítku (zpravidla k 1 : 2 000).


#### Schéma `overview_13kk` 
Schéma obsahuje vrstvy (tabulky) zobrazitelné zpravidla v měřítku 1 : 13 000 000.


#### Schéma `overview_75k` 
Schéma obsahuje vrstvy (tabulky) zobrazitelné zpravidla v měřítku 1 : 75 000.


#### Schéma `public` 
Jedná so o výchozí schéma, které v rámci daného projektu obsahuje zejména konfigurační nastavení databáze, QGIS projektu
a výchozí stylování tabulek (vrstev). Pro účely práce s prostorovými daty (PostGIS) jsou součástí výchozího schématu metadatové tabulky
pro integraci lokálních a globálních kordinačních referenčních systémů (`geoography_column`, `geometry_column`, `spatial_ref_sys`).
Jelikož je projekt primárně zpracováván v prostředí QGIS, tak je do databáze ukládáno výchozí stylování vektorových vrstev (`layer_styles`)
včetně projektového souboru v rámci (`qgis_projects`), který v sobě skrývá cesty importovaných vektorových vrstev z PostgreSQL databáze, 
doprovodných rastrových snímků či WMS služeb. Pro účely exportu jsou v projektovém souboru uloženy výkresové sestavy

### Zálohování databáze
Databáze je zálohována a následně šifrována za pomocí [**GNU Privacy Guard**](https://www.gnupg.org/software/index.html).

Po spuštění skriptu v terminálu `python ./database/backup/run_backup_encrypt.py` je uživatel vyzván k zadání hesla pro účely šifrování.
Následně potvrdí nově zvolené heslo. Pokud je databáze zabezpečena heslem, tak je nutné zadat i toto heslo. 

Šifrovanou databázi lze dešifrovat příkazem v terminálu `gpg --output output_file.sql --decrypt input_file.sql.gpg`, kde `output_file.sql`
reprezentuje dešifrovanou databázi, zatímco `input_file.sql.gpg` představuje vstupní, zašifrovanou databázi.

<img src="./docs_images/encrypt_database.png" alt="Encrypt database in terminal" style="width:500px;height:100px;"/>

### Export stylů do databazáze
V prostředí QGIS lze vyexportovat styly níže uvedeným postupem:
`Layer Properties` > `Export` > `Save as QGIS Layer Style File`.
Po vyexportování bude styl propojen s odpovídající vrstvou (tabulkou v databázi).

<img src="./docs_images/qgis_save_layer_style.png" alt="Save Layer Style" style="width:300px;height:400px;"/>



## Výstupy
### Sledovaný úsek - obecný přehled (1 : 60 000)
### Sledovaný úsek - podúseky (1 : 60 000)
### Atlas I. Generalizovaný průběh překážek (1 : 2 000)
### Atlas II. Detailní průběh překážek (1 : 1 000)
